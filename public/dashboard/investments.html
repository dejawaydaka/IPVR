<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Investments - RealSphere</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>
  
  <!-- Sidebar Container -->
  <div id="sidebar-container"></div>

  <!-- Main Content -->
  <div class="main-content">
    <header>
      <h1>Investment Plans</h1>
      <div class="user-info">
        <span id="userBalance">Loading...</span>
      </div>
    </header>

    <div class="page-section">
      <h2>Choose Your Investment Plan</h2>
      <p style="margin-bottom: 2rem; opacity: 0.8;">Select a plan below to start earning daily returns</p>
      
      <div class="error-message" id="errorMessage"></div>
      <div class="success-message" id="successMessage"></div>

      <div class="plans-grid" id="plansGrid">
        <!-- Plans will be rendered here -->
      </div>
    </div>
  </div>

  <!-- Invest Modal -->
  <div class="modal-overlay" id="investModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="investModalTitle">Invest in Plan</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="investForm">
          <div class="form-group">
            <label>Plan</label>
            <input type="text" id="investPlanName" readonly style="background: rgba(0,0,0,0.2);">
          </div>
          <div class="form-group">
            <label>Amount (USD)</label>
            <input type="number" id="investAmount" placeholder="Enter investment amount" min="1" step="0.01" required>
            <small style="color: rgba(255,255,255,0.6); margin-top: 0.5rem; display: block;">
              Minimum: $<span id="minAmount">0</span>
            </small>
          </div>
          <div class="form-group">
            <label>Available Balance</label>
            <input type="text" id="availableBalance" readonly style="background: rgba(0,0,0,0.2);">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('investModal')">Cancel</button>
        <button class="btn" onclick="confirmInvestment()">Confirm Investment</button>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    const investmentPlans = [
      { name: "Starter Plan", range: "$50 - $499", min: 50, max: 499, daily: "2%", total: "14%", duration: "7 days", dailyPercent: 0.02 },
      { name: "Bronze Plan", range: "$500 - $999", min: 500, max: 999, daily: "2.5%", total: "17.5%", duration: "7 days", dailyPercent: 0.025 },
      { name: "Silver Plan", range: "$1,000 - $1,999", min: 1000, max: 1999, daily: "3%", total: "21%", duration: "7 days", dailyPercent: 0.03 },
      { name: "Gold Plan", range: "$2,000 - $3,999", min: 2000, max: 3999, daily: "3.5%", total: "24.5%", duration: "7 days", dailyPercent: 0.035 },
      { name: "Diamond Plan", range: "$4,000 - $6,999", min: 4000, max: 6999, daily: "4%", total: "28%", duration: "7 days", dailyPercent: 0.04 },
      { name: "Elite Plan", range: "$7,000+", min: 7000, max: 999999, daily: "5%", total: "35%", duration: "7 days", dailyPercent: 0.05 }
    ];

    let currentUser = null;
    let selectedPlan = null;

    function renderPlans() {
      const grid = document.getElementById('plansGrid');
      if (!grid) return;

      grid.innerHTML = investmentPlans.map(plan => `
        <div class="plan-card" style="animation-delay: ${investmentPlans.indexOf(plan) * 0.1}s">
          <h3>${plan.name}</h3>
          <p class="plan-range">${plan.range}</p>
          <div class="plan-rate">${plan.daily}</div>
          <p class="plan-duration">Daily â€¢ ${plan.duration}</p>
          <p style="margin-bottom: 1.5rem; color: rgba(255,255,255,0.7);">Total Return: ${plan.total}</p>
          <button class="invest-btn" onclick="openInvestModal('${plan.name}')">
            <i class="fas fa-coins"></i> Invest Now
          </button>
        </div>
      `).join('');
    }

    function openInvestModal(planName) {
      selectedPlan = investmentPlans.find(p => p.name === planName);
      if (!selectedPlan) return;

      if (!currentUser) {
        showError('Please login to invest');
        return;
      }

      document.getElementById('investPlanName').value = selectedPlan.name;
      document.getElementById('minAmount').textContent = selectedPlan.min.toLocaleString();
      document.getElementById('investAmount').min = selectedPlan.min;
      document.getElementById('investAmount').max = selectedPlan.max === 999999 ? '' : selectedPlan.max;
      
      updateAvailableBalance();
      openModal('investModal');
    }

    async function updateAvailableBalance() {
      if (!currentUser) return;
      
      try {
        const userData = await fetchUserData(currentUser.email);
        const totalProfit = Number(userData.totalProfit || 0);
        const balance = Number(userData.balance || 0);
        const totalInvestment = Number(userData.totalInvestment || 0);
        const available = balance + totalProfit - totalInvestment;
        
        document.getElementById('availableBalance').value = `$${available.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        document.getElementById('userBalance').textContent = `Balance: $${available.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      } catch (error) {
        console.error('Error fetching balance:', error);
      }
    }

    async function confirmInvestment() {
      if (!selectedPlan || !currentUser) return;

      const amount = Number(document.getElementById('investAmount').value);
      
      if (!amount || amount < selectedPlan.min) {
        showError(`Minimum investment is $${selectedPlan.min}`);
        return;
      }

      if (selectedPlan.max !== 999999 && amount > selectedPlan.max) {
        showError(`Maximum investment is $${selectedPlan.max}`);
        return;
      }

      try {
        const userData = await fetchUserData(currentUser.email);
        const totalProfit = Number(userData.totalProfit || 0);
        const balance = Number(userData.balance || 0);
        const totalInvestment = Number(userData.totalInvestment || 0);
        const available = balance + totalProfit - totalInvestment;

        if (amount > available) {
          showError(`Insufficient balance. Available: $${available.toLocaleString(undefined, {minimumFractionDigits: 2})}`);
          return;
        }

        const result = await makeInvestment(currentUser.email, amount, selectedPlan.name);
        showSuccess('Investment successful!');
        closeModal('investModal');
        document.getElementById('investForm').reset();
        await updateAvailableBalance();
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 1500);
      } catch (error) {
        showError(error.message || 'Investment failed');
      }
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      currentUser = getCurrentUser();
      if (!currentUser) return;

      renderPlans();
      await updateAvailableBalance();
    });
  </script>
</body>
</html>

