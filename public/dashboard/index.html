<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - RealSphere</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/Rsblack.png">
  <link rel="shortcut icon" type="image/png" href="/Rsblack.png">
  <link rel="apple-touch-icon" href="/Rsblack.png">
  
  <!-- Open Graph / Social Media Meta Tags -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Dashboard - RealSphere">
  <meta property="og:description" content="Manage your real estate investments and track your portfolio performance on RealSphere.">
  <meta property="og:image" content="https://realsphereltd.com/Rsblack.png">
  <meta property="og:url" content="https://realsphereltd.com/dashboard/index.html">
  <meta property="og:site_name" content="RealSphere">
  
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Dashboard - RealSphere">
  <meta name="twitter:description" content="Manage your real estate investments and track your portfolio performance on RealSphere.">
  <meta name="twitter:image" content="https://realsphereltd.com/Rsblack.png">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>
  
  <!-- Dashboard Logo (Top Left) -->
  <div class="dashboard-logo">
    <a href="../index.html" style="display: inline-block; cursor: pointer; background: transparent; background-color: transparent;">
      <img src="../1.png" alt="RealSphere" style="background: transparent; background-color: transparent; object-fit: contain;">
    </a>
  </div>
  
  <!-- Mobile Hamburger Menu -->
  <div class="mobile-menu-toggle" id="mobileMenuToggle">
    <i class="fas fa-bars"></i>
  </div>
  
  <!-- Sidebar Container -->
  <div id="sidebar-container"></div>

  <!-- Main Content -->
  <div class="main-content">
    <header>
      <div class="user-info">
        <h1>Welcome Back, <span id="dashUserName">Investor</span> ðŸ‘‹</h1>
        <div class="user-details">
          <span class="user-role" id="dashUserRole">User</span>
          <span class="user-email" id="dashUserEmail">-</span>
        </div>
      </div>
      <div class="header-spacer"></div>
    </header>

    <div class="kyc-warning" id="kycWarning" style="display: none;">
      <div class="kyc-warning-content">
        <div class="kyc-warning-icon">
          <i class="fas fa-shield-alt"></i>
        </div>
        <div class="kyc-warning-text">
          <strong id="kycWarningTitle">Complete Your KYC</strong>
          <p id="kycWarningMessage">Verify your identity to unlock full access to RealSphere.</p>
        </div>
        <button class="btn btn-primary" id="openKycModal">Complete KYC</button>
      </div>
    </div>

    <!-- Metrics Cards -->
    <div class="metrics-grid">
      <div class="metric-card" style="animation-delay: 0.1s;">
        <div class="metric-icon"><i class="fas fa-wallet"></i></div>
        <h3>Total Balance</h3>
        <div class="metric-value" id="dashTotalBalance">$0</div>
      </div>
      <div class="metric-card" style="animation-delay: 0.2s;">
        <div class="metric-icon"><i class="fas fa-chart-line"></i></div>
        <h3>Total Investment</h3>
        <div class="metric-value" id="dashTotalInvestment">$0</div>
      </div>
      <div class="metric-card" style="animation-delay: 0.3s;">
        <div class="metric-icon"><i class="fas fa-dollar-sign"></i></div>
        <h3>Daily Earnings</h3>
        <div class="metric-value" id="dashDailyEarnings">$0</div>
      </div>
      <div class="metric-card" style="animation-delay: 0.4s;">
        <div class="metric-icon"><i class="fas fa-gift"></i></div>
        <h3>Bonus</h3>
        <div class="metric-value" id="dashBonus">$0</div>
      </div>
      <div class="metric-card" style="animation-delay: 0.5s;">
        <div class="metric-icon"><i class="fas fa-coins"></i></div>
        <h3>Total Deposits</h3>
        <div class="metric-value" id="dashTotalDeposits">$0</div>
      </div>
      <div class="metric-card" style="animation-delay: 0.6s;">
        <div class="metric-icon"><i class="fas fa-trophy"></i></div>
        <h3>Total Profit</h3>
        <div class="metric-value" id="dashTotalProfit">$0</div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
      <div class="chart-card">
        <h3>Daily Earnings Trend</h3>
        <canvas id="earningsChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>Investment Distribution</h3>
        <canvas id="portfolioChart"></canvas>
      </div>
    </div>

    <div class="referral-card" id="referralCard" style="display: none;">
      <div class="referral-heading">
        <span class="referral-badge">Referral Rewards</span>
        <h2>Invite &amp; Earn $5</h2>
        <p>Share your unique referral link. Once your invitee verifies their account, your $5 bonus posts immediately.</p>
      </div>
      <div class="referral-input">
        <input type="text" id="referralLinkInput" readonly>
        <button class="btn btn-primary" id="copyReferralLink"><i class="fas fa-copy"></i> Copy Link</button>
      </div>
      <div class="referral-foot">
        <span class="referral-code-label">Referral Code: <strong id="referralCodeLabel">-</strong></span>
      </div>
      <div class="referral-status">
        <div class="referral-highlight">
          <i class="fas fa-bolt"></i>
          <div>
            <span class="highlight-title">Instant Credit</span>
            <span class="highlight-text">Bonus hits your balance after verification</span>
          </div>
        </div>
        <div class="referral-highlight">
          <i class="fas fa-chart-line"></i>
          <div>
            <span class="highlight-title">Auto Tracking</span>
            <span class="highlight-text">Logged in transactions &amp; bonus history</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Investment Table -->
    <div class="table-section">
      <h2>Investment Overview</h2>
      <div class="error-message" id="errorMessage"></div>
      <div class="success-message" id="successMessage"></div>
      <table id="investmentsTable">
        <thead>
          <tr>
            <th>Pricing Tier</th>
            <th>Amount</th>
            <th>ROI</th>
            <th>Status</th>
            <th>Start Date</th>
            <th>Profit</th>
          </tr>
        </thead>
        <tbody id="investmentsBody">
          <tr>
            <td colspan="6">
              <div class="empty-state">
                <i class="fas fa-chart-line"></i>
                <p>Loading investments...</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Transaction History Section -->
    <div class="table-section">
      <h2><i class="fas fa-history"></i> Transaction History</h2>
      <table id="transactionsTable">
        <thead>
          <tr>
            <th>Type</th>
            <th>Amount</th>
            <th>Currency</th>
            <th>Status</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody id="transactionsBody">
          <tr>
            <td colspan="6">
              <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>Loading transactions...</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- KYC Modal -->
  <div class="modal-overlay" id="kycModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Verify Your Identity</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <p class="modal-lead">Upload a valid government-issued ID so we can activate investments and withdrawals for your account.</p>
        <form id="kycForm" class="kyc-modal-form" enctype="multipart/form-data">
          <div class="modal-form-grid">
            <div class="form-field">
              <label for="kycFullName">Full Name</label>
              <input type="text" id="kycFullName" name="fullName" placeholder="Enter full name as on ID" required>
            </div>
            <div class="form-field">
              <label for="kycFront">Front of ID</label>
              <input type="file" id="kycFront" name="kycFront" accept="image/*" required>
            </div>
            <div class="form-field">
              <label for="kycBack">Back of ID</label>
              <input type="file" id="kycBack" name="kycBack" accept="image/*" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="closeModal('kycModal')">Cancel</button>
            <button type="submit" class="btn btn-primary" id="kycSubmitBtn">Submit KYC</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    // Helper function to sanitize HTML
    function sanitizeHTML(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    let earningsChart = null;
    let portfolioChart = null;
    const referralCard = document.getElementById('referralCard');
    const referralLinkInput = document.getElementById('referralLinkInput');
    const referralCodeLabel = document.getElementById('referralCodeLabel');
    const copyReferralLinkBtn = document.getElementById('copyReferralLink');
    const kycWarning = document.getElementById('kycWarning');
    const kycWarningTitle = document.getElementById('kycWarningTitle');
    const kycWarningMessage = document.getElementById('kycWarningMessage');
    const openKycModalBtn = document.getElementById('openKycModal');
    const kycModal = document.getElementById('kycModal');
    const kycForm = document.getElementById('kycForm');
    const kycSubmitBtn = document.getElementById('kycSubmitBtn');

    function updateCharts(data) {
      // Ensure data exists, use empty object if not
      if (!data) {
        data = { dailyEarnings: 0, investments: [], transactions: [] };
      }
      
      // Daily Earnings Trend Chart (Line) - Dynamic based on historical profit transactions
      const ctx1 = document.getElementById('earningsChart');
      if (ctx1) {
        const days = [];
        const earnings = [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Get all profit transactions from the last 7 days
        const transactions = data.transactions || [];
        const profitTransactions = transactions.filter(txn => 
          txn.type === 'profit' && txn.status === 'completed'
        );
        
        // Calculate daily earnings for the last 7 days
        for (let i = 6; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          days.push(dateStr);
          
          // Calculate earnings for this specific day
          const dayStart = new Date(date);
          dayStart.setHours(0, 0, 0, 0);
          const dayEnd = new Date(date);
          dayEnd.setHours(23, 59, 59, 999);
          
          let dayEarnings = 0;
          profitTransactions.forEach(txn => {
            const txnDate = new Date(txn.createdAt || txn.timestamp || 0);
            if (txnDate >= dayStart && txnDate <= dayEnd) {
              dayEarnings += Number(txn.amount || 0);
            }
          });
          
          // If no transactions for this day, use current daily earnings rate for today
          if (i === 0 && dayEarnings === 0) {
            dayEarnings = data.dailyEarnings || 0;
          }
          
          earnings.push(parseFloat(dayEarnings.toFixed(2)));
        }
        
        // Ensure we have at least some data
        if (earnings.every(e => e === 0) && data.dailyEarnings > 0) {
          // If no historical data but current daily earnings exist, show current rate
          earnings[6] = data.dailyEarnings;
        }
        
        if (!earningsChart) {
          // Create chart if it doesn't exist
          earningsChart = new Chart(ctx1, {
            type: 'line',
            data: {
              labels: days,
              datasets: [{
                label: 'Daily Earnings ($)',
                data: earnings,
                borderColor: '#4ef5a3',
                backgroundColor: 'rgba(78, 245, 163, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: '#4ef5a3',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              animation: {
                duration: 750
              },
              plugins: {
                legend: {
                  labels: { color: '#fff' }
                },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  titleColor: '#fff',
                  bodyColor: '#fff',
                  borderColor: '#4ef5a3',
                  borderWidth: 1
                }
              },
              scales: {
                x: { 
                  ticks: { color: '#fff' }, 
                  grid: { color: 'rgba(255,255,255,0.1)' } 
                },
                y: { 
                  ticks: { 
                    color: '#fff',
                    callback: function(value) {
                      return '$' + value.toFixed(2);
                    }
                  }, 
                  grid: { color: 'rgba(255,255,255,0.1)' },
                  beginAtZero: true
                }
              }
            }
          });
        } else {
          // Update existing chart with new data and labels
          earningsChart.data.labels = days;
          earningsChart.data.datasets[0].data = earnings;
          earningsChart.update('active'); // Use 'active' for smoother animation
        }
      }

      // Portfolio Composition Chart (Doughnut) - Sync with investments data
      const ctx2 = document.getElementById('portfolioChart');
      if (ctx2) {
        const planCounts = {};
        const investments = data.investments || [];
        
        // Calculate total per plan
        investments.forEach(inv => {
          if (inv && inv.plan) {
            const planName = inv.plan || 'Unknown Pricing Tier';
            const amount = Number(inv.amount || 0);
            if (amount > 0) {
              planCounts[planName] = (planCounts[planName] || 0) + amount;
            }
          }
        });
        
        const planLabels = Object.keys(planCounts);
        const planValues = Object.values(planCounts);
        
        // Always ensure at least one label exists
        if (planLabels.length === 0) {
          planLabels.push('No Investments');
          planValues.push(1);
        }
        
        // Generate colors dynamically based on number of plans
        const colors = [
          'rgba(78, 245, 163, 0.8)',
          'rgba(34, 197, 94, 0.8)',
          'rgba(22, 91, 71, 0.8)',
          'rgba(10, 61, 46, 0.8)',
          'rgba(15, 46, 35, 0.8)',
          'rgba(31, 184, 116, 0.8)',
          'rgba(16, 185, 129, 0.8)',
          'rgba(5, 150, 105, 0.8)'
        ];
        
        if (!portfolioChart) {
          // Create chart if it doesn't exist
          portfolioChart = new Chart(ctx2, {
            type: 'doughnut',
            data: {
              labels: planLabels,
              datasets: [{
                data: planValues,
                backgroundColor: colors.slice(0, planLabels.length)
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              animation: {
                duration: 750
              },
              plugins: {
                legend: {
                  labels: { color: '#fff' },
                  position: 'bottom'
                },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  titleColor: '#fff',
                  bodyColor: '#fff',
                  borderColor: '#4ef5a3',
                  borderWidth: 1,
                  callbacks: {
                    label: function(context) {
                      const label = context.label || '';
                      const value = context.parsed || 0;
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                      return `${label}: $${value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${percentage}%)`;
                    }
                  }
                }
              }
            }
          });
        } else {
          // Update existing chart with new data
          portfolioChart.data.labels = planLabels;
          portfolioChart.data.datasets[0].data = planValues;
          portfolioChart.data.datasets[0].backgroundColor = colors.slice(0, planLabels.length);
          portfolioChart.update('active'); // Use 'active' for smoother animation
        }
      }
    }

    function updateReferralSection(data) {
      if (!referralCard) return;
      if (!data || !data.referralCode) {
        referralCard.style.display = 'none';
        return;
      }

      const origin = window.location.origin || `${window.location.protocol}//${window.location.host}`;
      const referralLink = data.referralLink || `${origin}/register.html?ref=${encodeURIComponent(data.referralCode)}`;

      referralCard.style.display = 'flex';
      if (referralLinkInput) {
        referralLinkInput.value = referralLink;
      }
      if (referralCodeLabel) {
        referralCodeLabel.textContent = data.referralCode;
      }
    }

    let isKycApproved = false;

    function updateKycUI(data) {
      const status = (data?.kycStatus || 'pending').toLowerCase();
      isKycApproved = status === 'approved';
      localStorage.setItem('rs_kyc_status', status);

      if (!kycWarning) return;

      if (isKycApproved) {
        kycWarning.style.display = 'none';
        closeModal('kycModal');
        document.body.classList.remove('kyc-active');
        return;
      }

      document.body.classList.add('kyc-active');
      kycWarning.style.display = 'block';

      if (kycWarningTitle) {
        if (status === 'submitted') {
          kycWarningTitle.textContent = 'KYC Under Review';
        } else if (status === 'rejected') {
          kycWarningTitle.textContent = 'KYC Needs Attention';
        } else {
          kycWarningTitle.textContent = 'Complete Your KYC';
        }
      }

      if (kycWarningMessage) {
        if (status === 'submitted') {
          kycWarningMessage.textContent = 'Your documents are under review. We\'ll notify you as soon as verification is complete.';
        } else if (status === 'rejected') {
          kycWarningMessage.textContent = 'We could not verify your last submission. Please upload clear front and back images of your ID.';
        } else {
          kycWarningMessage.textContent = 'Verify your identity to unlock investments, withdrawals, and full account access.';
        }
      }

      if (openKycModalBtn) {
        openKycModalBtn.textContent = status === 'submitted' ? 'View Submission' : 'Complete KYC';
      }

      if (kycForm) {
        const fullNameInput = document.getElementById('kycFullName');
        if (fullNameInput && data?.name && !fullNameInput.value) {
          fullNameInput.value = data.name;
        }

        const fields = Array.from(kycForm.elements || []);
        const reviewing = status === 'submitted';
        fields.forEach(field => {
          if (field && field.id !== 'kycSubmitBtn') {
            field.disabled = reviewing;
          }
        });
        if (kycSubmitBtn) {
          if (reviewing) {
            kycSubmitBtn.disabled = true;
            kycSubmitBtn.textContent = 'Under Review';
          } else {
            kycSubmitBtn.disabled = false;
            kycSubmitBtn.textContent = 'Submit KYC';
          }
        }
      }
    }

    async function submitKycForm(event) {
      event.preventDefault();
      const user = getCurrentUser();
      if (!user || !user.email) {
        showError('Unable to identify user. Please log in again.');
        return;
      }

      const fullNameInput = document.getElementById('kycFullName');
      const frontFile = document.getElementById('kycFront')?.files[0];
      const backFile = document.getElementById('kycBack')?.files[0];

      if (!frontFile || !backFile) {
        showError('Please upload both the front and back of your ID card.');
        return;
      }

      const formData = new FormData();
      formData.append('fullName', fullNameInput?.value?.trim() || '');
      formData.append('kycFront', frontFile);
      formData.append('kycBack', backFile);

      if (kycSubmitBtn) {
        kycSubmitBtn.disabled = true;
        kycSubmitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
      }

      try {
        const response = await fetch(`/api/user/${encodeURIComponent(user.email)}/kyc`, {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          showSuccess('KYC submitted successfully! We\'ll notify you once it\'s approved.');
          if (kycForm) {
            kycForm.reset();
          }
          closeModal('kycModal');
          await refreshDashboard();
        } else {
          const errorData = await response.json().catch(() => ({}));
          showError(errorData.message || 'Failed to submit KYC. Please try again.');
        }
      } catch (err) {
        console.error('KYC submission error:', err);
        showError('An error occurred while submitting KYC. Please try again.');
      } finally {
        if (kycSubmitBtn) {
          kycSubmitBtn.disabled = false;
          kycSubmitBtn.innerHTML = 'Submit KYC';
        }
      }
    }

    // Store last successful data to preserve on errors
    let lastSuccessfulData = null;

    // Helper function to render investments table
    function renderInvestmentsTable(investments) {
      const body = document.getElementById('investmentsBody');
      if (!body) return;
      
      if (!Array.isArray(investments)) {
        investments = [];
      }
      
      if (investments.length === 0) {
        body.innerHTML = `
          <tr>
            <td colspan="6">
              <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No investments yet. Start investing to see your portfolio here.</p>
              </div>
            </td>
          </tr>
        `;
      } else {
        body.innerHTML = investments.map(inv => {
          if (!inv) return '';
          const rate = profitRates[inv.plan] || 0;
          let start;
          try {
            start = new Date(inv.startDate);
            if (isNaN(start.getTime())) {
              start = new Date();
            }
          } catch (e) {
            start = new Date();
          }
          const status = Math.floor((Date.now() - (inv.startDate || Date.now())) / (1000*60*60*24)) < (inv.days||7) ? 'Active' : 'Completed';
          return `<tr>
            <td>${sanitizeHTML(inv.plan || 'N/A')}</td>
            <td>$${Number(inv.amount || 0).toLocaleString()}</td>
            <td>${(rate*100).toFixed(1)}% Daily</td>
            <td><span style="color: ${status === 'Active' ? '#4ef5a3' : '#888'}">${status}</span></td>
            <td>${start.toISOString().split('T')[0]}</td>
            <td>$${(Number(inv.profit||0)).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}</td>
          </tr>`;
        }).join('');
      }
    }

    // Helper function to render transactions table
    function renderTransactionsTable(data) {
      const transactionsBody = document.getElementById('transactionsBody');
      if (!transactionsBody) {
        console.error('[Dashboard] transactionsBody element not found!');
        return;
      }
      
      const deposits = data?.deposits || [];
      const transactions = data?.transactions || [];
      
      console.log('[Dashboard] Rendering transactions - Deposits:', deposits.length, 'Transactions:', transactions.length);
      
      // Combine all transactions (deposits, bonuses, etc.)
      const allTransactions = [];
      
      // Add deposits as transactions
      if (Array.isArray(deposits)) {
        deposits.forEach((dep) => {
          if (dep) {
            allTransactions.push({
              type: 'deposit',
              amount: dep.amount || 0,
              currency: dep.currency || 'USD',
              status: dep.status || 'pending',
              createdAt: dep.createdAt || dep.timestamp || Date.now(),
              transactionHash: dep.transactionHash,
              id: dep.id
            });
          }
        });
      }
      
      // Add other transactions (bonuses, etc.)
      if (Array.isArray(transactions)) {
        transactions.forEach((txn) => {
          if (txn) {
            console.log('[Dashboard] Processing transaction:', txn.type, txn.amount, txn);
            allTransactions.push({
              type: txn.type || 'transaction',
              amount: txn.amount || 0,
              currency: txn.currency || 'USD',
              status: txn.status || 'completed',
              createdAt: txn.createdAt || txn.timestamp || Date.now(),
              description: txn.description,
              id: txn.id
            });
          }
        });
        
        // Log registration bonuses specifically
        const regBonuses = transactions.filter(t => t.type === 'registration_bonus');
        if (regBonuses.length > 0) {
          console.log(`[Dashboard] Found ${regBonuses.length} registration bonus transaction(s):`, regBonuses);
        } else {
          console.log('[Dashboard] No registration bonus transactions found in transactions array');
        }
      } else {
        console.warn('[Dashboard] Transactions is not an array:', transactions);
      }
      
      // Sort by date (newest first)
      allTransactions.sort((a, b) => {
        const aTime = Number(a.createdAt || 0);
        const bTime = Number(b.createdAt || 0);
        return bTime - aTime;
      });
      
      console.log('[Dashboard] Combined transactions count:', allTransactions.length);
      
      // Always render transactions, even if empty
      if (allTransactions.length === 0) {
        transactionsBody.innerHTML = `
          <tr>
            <td colspan="6">
              <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No transactions yet. Your transaction history will appear here.</p>
              </div>
            </td>
          </tr>
        `;
      } else {
        transactionsBody.innerHTML = allTransactions.map((txn) => {
          if (!txn) return '';
          
          // Handle date conversion more robustly
          let date;
          try {
            const timestamp = Number(txn.createdAt || txn.timestamp || Date.now());
            date = new Date(timestamp);
            if (isNaN(date.getTime())) {
              date = new Date();
            }
          } catch (e) {
            console.error('[Dashboard] Error parsing date for transaction:', txn, e);
            date = new Date();
          }
          
          let statusColor = '#888';
          let statusText = txn.status || 'pending';
          let icon = 'fas fa-circle';
          let typeText = 'Transaction';
          
          // Determine icon and type text based on transaction type
          if (txn.type === 'deposit') {
            icon = 'fas fa-arrow-down';
            typeText = 'Deposit';
          } else if (txn.type === 'withdrawal') {
            icon = 'fas fa-arrow-up';
            typeText = 'Withdrawal';
          } else if (txn.type === 'registration_bonus') {
            icon = 'fas fa-gift';
            typeText = 'Registration Bonus';
          } else if (txn.type === 'investment') {
            icon = 'fas fa-chart-line';
            typeText = 'Investment';
          } else if (txn.type === 'profit') {
            icon = 'fas fa-coins';
            typeText = 'Profit';
          }
          
          if (statusText === 'approved' || statusText === 'completed') {
            statusColor = '#4ef5a3';
            statusText = statusText === 'completed' ? 'Completed' : 'Approved';
          } else if (statusText === 'pending') {
            statusColor = '#ffc107';
            statusText = 'Pending';
          } else if (statusText === 'rejected') {
            statusColor = '#ff4444';
            statusText = 'Rejected';
          }
          
          const details = txn.transactionHash 
            ? `<span style="font-family: monospace; font-size: 0.85rem;" title="${sanitizeHTML(txn.transactionHash)}">${sanitizeHTML((txn.transactionHash || '').substring(0, 20))}...</span>`
            : (txn.description || 'N/A');
          
          return `<tr>
            <td><i class="${icon}" style="color: #4ef5a3;"></i> ${sanitizeHTML(typeText)}</td>
            <td>$${Number(txn.amount || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            <td>${sanitizeHTML(txn.currency || 'USD')}</td>
            <td><span style="color: ${statusColor}; font-weight: 500;">${statusText}</span></td>
            <td>${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
            <td>${details}</td>
          </tr>`;
        }).join('');
      }
    }

    async function refreshDashboard() {
      const user = getCurrentUser();
      if (!user) return;

      const email = user.email || user.userEmail;
      console.log('[Dashboard] User email:', email);
      
      if (!email) {
        console.error('[Dashboard] No email found in user object:', user);
        showError('User email not found. Please login again.');
        return;
      }
      
      try {
        // Update profits first (non-blocking)
        try {
          await fetch('/profits/update', { method: 'POST', cache: 'no-store' });
        } catch (e) {
          console.warn('Profit update failed:', e);
        }
        
        // Fetch user data
        const data = await fetchUserData(email);
        
        // Validate data structure
        if (!data || typeof data !== 'object') {
          throw new Error('Invalid data structure received from server');
        }
        
        // Ensure arrays exist
        if (!Array.isArray(data.investments)) data.investments = [];
        if (!Array.isArray(data.deposits)) data.deposits = [];
        if (!Array.isArray(data.transactions)) data.transactions = [];
        
        // Store successful data for fallback BEFORE any rendering operations
        lastSuccessfulData = JSON.parse(JSON.stringify(data)); // Deep copy to prevent reference issues
        
        // Update metrics
        const totalBalance = Number(data.totalBalance || 0);
        const totalInvestment = Number(data.totalInvestment || 0);
        const dailyEarnings = Number(data.dailyEarnings || 0);
        const bonus = Number(data.bonus || 0);
        const totalDeposits = Number(data.totalDeposits || 0);
        const totalProfit = Number(data.totalProfit || 0);

        if (document.getElementById('dashTotalBalance')) animateCounter(document.getElementById('dashTotalBalance'), 0, totalBalance, 1000);
        if (document.getElementById('dashTotalInvestment')) animateCounter(document.getElementById('dashTotalInvestment'), 0, totalInvestment, 1000);
        if (document.getElementById('dashDailyEarnings')) animateCounter(document.getElementById('dashDailyEarnings'), 0, dailyEarnings, 1000);
        if (document.getElementById('dashBonus')) animateCounter(document.getElementById('dashBonus'), 0, bonus, 1000);
        if (document.getElementById('dashTotalDeposits')) animateCounter(document.getElementById('dashTotalDeposits'), 0, totalDeposits, 1000);
        if (document.getElementById('dashTotalProfit')) animateCounter(document.getElementById('dashTotalProfit'), 0, totalProfit, 1000);

        // Update user info
        const displayName = data.name || email.split('@')[0] || 'Investor';
        if (document.getElementById('dashUserName')) {
          document.getElementById('dashUserName').textContent = displayName;
        }
        if (document.getElementById('dashUserEmail')) {
          document.getElementById('dashUserEmail').textContent = email;
        }
        if (document.getElementById('dashUserRole')) {
          document.getElementById('dashUserRole').textContent = data.admin_approved ? 'Admin' : 'User';
        }

        // Update investments table using helper function
        renderInvestmentsTable(data.investments);

        // Update transaction history table using helper function
        renderTransactionsTable(data);

        // Update charts - always update with current data
        updateCharts(data);
        updateReferralSection(data);
        updateKycUI(data);
        
        // Clear any previous errors
        const errorEl = document.getElementById('errorMessage');
        if (errorEl) {
          errorEl.textContent = '';
          errorEl.style.display = 'none';
        }
      } catch (error) {
        console.error('[Dashboard] Refresh failed:', error);
        console.error('[Dashboard] Error details:', error.message, error.stack);
        
        // Use last successful data if available to preserve display
        if (lastSuccessfulData) {
          console.log('[Dashboard] Using cached data due to error - re-rendering from cache');
          try {
            // Re-render everything from cached data
            const cachedData = lastSuccessfulData;
            
            // Update metrics from cached data
            const totalBalance = Number(cachedData.totalBalance || 0);
            const totalInvestment = Number(cachedData.totalInvestment || 0);
            const dailyEarnings = Number(cachedData.dailyEarnings || 0);
            const bonus = Number(cachedData.bonus || 0);
            const totalDeposits = Number(cachedData.totalDeposits || 0);
            const totalProfit = Number(cachedData.totalProfit || 0);

            if (document.getElementById('dashTotalBalance')) animateCounter(document.getElementById('dashTotalBalance'), 0, totalBalance, 1000);
            if (document.getElementById('dashTotalInvestment')) animateCounter(document.getElementById('dashTotalInvestment'), 0, totalInvestment, 1000);
            if (document.getElementById('dashDailyEarnings')) animateCounter(document.getElementById('dashDailyEarnings'), 0, dailyEarnings, 1000);
            if (document.getElementById('dashBonus')) animateCounter(document.getElementById('dashBonus'), 0, bonus, 1000);
            if (document.getElementById('dashTotalDeposits')) animateCounter(document.getElementById('dashTotalDeposits'), 0, totalDeposits, 1000);
            if (document.getElementById('dashTotalProfit')) animateCounter(document.getElementById('dashTotalProfit'), 0, totalProfit, 1000);
            
            // Re-render investments and transactions from cached data
            renderInvestmentsTable(cachedData.investments || []);
            renderTransactionsTable(cachedData);
            
            // Update charts from cached data
            updateCharts(cachedData);
            updateReferralSection(cachedData);
            updateKycUI(cachedData);
            
            console.log('[Dashboard] Successfully restored dashboard from cached data');
          } catch (renderError) {
            console.error('[Dashboard] Error rendering cached data:', renderError);
          }
        } else {
          // Only show error if we have no data at all
          const balanceEl = document.getElementById('dashTotalBalance');
          const hasData = balanceEl && balanceEl.textContent && balanceEl.textContent !== '$0.00' && balanceEl.textContent !== '0' && balanceEl.textContent !== '$0';
          
          if (!hasData) {
            showError('Could not load dashboard data. Please try refreshing the page.');
          } else {
            console.warn('[Dashboard] Error occurred but data is already displayed');
          }
        }
      } finally {
        // Always hide loading overlay
        showLoading(false);
      }
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
      console.log('[Dashboard] Page loaded, initializing...');
      const user = getCurrentUser();
      if (!user) {
        console.error('[Dashboard] No user found, redirecting...');
        return;
      }

      console.log('[Dashboard] User found:', user);
      showLoading(true);
      if (copyReferralLinkBtn) {
        copyReferralLinkBtn.addEventListener('click', () => {
          if (!referralLinkInput || !referralLinkInput.value) {
            showError('Referral link is not available yet.');
            return;
          }
          navigator.clipboard.writeText(referralLinkInput.value).then(() => {
            showSuccess('Referral link copied to clipboard.');
          }).catch(() => {
            try {
              referralLinkInput.select();
              document.execCommand('copy');
              showSuccess('Referral link copied to clipboard.');
            } catch (_) {
              showError('Unable to copy referral link.');
            }
          });
        });
      }

      if (openKycModalBtn) {
        openKycModalBtn.addEventListener('click', () => {
          if (typeof openModal === 'function') {
            openModal('kycModal');
          } else if (kycModal) {
            kycModal.classList.add('active');
            document.body.style.overflow = 'hidden';
          }
        });
      }

      if (typeof setupModalClose === 'function') {
        setupModalClose();
      }

      if (kycForm) {
        kycForm.addEventListener('submit', submitKycForm);
      }
      
      // Small delay to ensure DOM is ready, then refresh
      setTimeout(() => {
        refreshDashboard().catch(err => {
          console.error('[Dashboard] Initial refresh failed:', err);
          // If initial refresh fails, try again after a short delay
          setTimeout(() => {
            console.log('[Dashboard] Retrying dashboard refresh...');
            refreshDashboard();
          }, 2000);
        });
      }, 100);
      
      // Refresh every 30 seconds
      setInterval(() => {
        refreshDashboard().catch(err => {
          console.error('[Dashboard] Scheduled refresh failed:', err);
        });
      }, 30000);
    });
    
    // Also refresh when page becomes visible (user returns to tab)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        console.log('[Dashboard] Page became visible, refreshing...');
        refreshDashboard().catch(err => {
          console.error('[Dashboard] Visibility refresh failed:', err);
        });
      }
    });
  </script>
  
  <!-- Smartsupp Live Chat script -->
  <script type="text/javascript">
      var _smartsupp = _smartsupp || {};
      _smartsupp.key = '2f2fecf5784eca7c31d959fd1e245ed22d4971ab';
      window.smartsupp||(function(d) {
          var s,c,o=smartsupp=function(){ o._.push(arguments)};o._=[];
          s=d.getElementsByTagName('script')[0];c=d.createElement('script');
          c.type='text/javascript';c.charset='utf-8';c.async=true;
          c.src='https://www.smartsuppchat.com/loader.js?';s.parentNode.insertBefore(c,s);
      })(document);
  </script>
  <noscript> Powered by <a href="https://www.smartsupp.com" target="_blank">Smartsupp</a></noscript>
</body>
</html>

