<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - RealSphere</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>
  
  <!-- Sidebar Container -->
  <div id="sidebar-container"></div>

  <!-- Main Content -->
  <div class="main-content">
    <header>
      <h1>Welcome Back, <span id="dashUserName">Investor</span> ðŸ‘‹</h1>
      <div class="user-info">
        <img id="dashAvatar" src="https://i.pravatar.cc/45" alt="User" />
        <span id="dashUserEmail">-</span>
      </div>
    </header>

    <!-- Metrics Cards -->
    <div class="metrics-grid">
      <div class="metric-card" style="animation-delay: 0.1s;">
        <div class="metric-icon"><i class="fas fa-wallet"></i></div>
        <h3>Total Balance</h3>
        <div class="metric-value" id="dashTotalBalance">$0</div>
      </div>
      <div class="metric-card" style="animation-delay: 0.2s;">
        <div class="metric-icon"><i class="fas fa-chart-line"></i></div>
        <h3>Total Investment</h3>
        <div class="metric-value" id="dashTotalInvestment">$0</div>
      </div>
      <div class="metric-card" style="animation-delay: 0.3s;">
        <div class="metric-icon"><i class="fas fa-dollar-sign"></i></div>
        <h3>Daily Earnings</h3>
        <div class="metric-value" id="dashDailyEarnings">$0</div>
      </div>
      <div class="metric-card" style="animation-delay: 0.4s;">
        <div class="metric-icon"><i class="fas fa-gift"></i></div>
        <h3>Bonus</h3>
        <div class="metric-value" id="dashBonus">$0</div>
      </div>
      <div class="metric-card" style="animation-delay: 0.5s;">
        <div class="metric-icon"><i class="fas fa-coins"></i></div>
        <h3>Total Deposits</h3>
        <div class="metric-value" id="dashTotalDeposits">$0</div>
      </div>
      <div class="metric-card" style="animation-delay: 0.6s;">
        <div class="metric-icon"><i class="fas fa-trophy"></i></div>
        <h3>Total Profit</h3>
        <div class="metric-value" id="dashTotalProfit">$0</div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
      <div class="chart-card">
        <h3>Daily Earnings Trend</h3>
        <canvas id="earningsChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>Investment Distribution</h3>
        <canvas id="portfolioChart"></canvas>
      </div>
    </div>

    <!-- Investment Table -->
    <div class="table-section">
      <h2>Investment Overview</h2>
      <div class="error-message" id="errorMessage"></div>
      <div class="success-message" id="successMessage"></div>
      <table id="investmentsTable">
        <thead>
          <tr>
            <th>Plan</th>
            <th>Amount</th>
            <th>ROI</th>
            <th>Status</th>
            <th>Start Date</th>
            <th>Profit</th>
          </tr>
        </thead>
        <tbody id="investmentsBody">
          <tr>
            <td colspan="6">
              <div class="empty-state">
                <i class="fas fa-chart-line"></i>
                <p>Loading investments...</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    let earningsChart = null;
    let portfolioChart = null;

    function updateCharts(data) {
      // Daily Earnings Trend Chart (Line)
      const ctx1 = document.getElementById('earningsChart');
      if (ctx1 && !earningsChart) {
        const days = [];
        const earnings = [];
        for (let i = 6; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
          earnings.push(data.dailyEarnings || 0);
        }
        
        earningsChart = new Chart(ctx1, {
          type: 'line',
          data: {
            labels: days,
            datasets: [{
              label: 'Daily Earnings ($)',
              data: earnings,
              borderColor: '#4ef5a3',
              backgroundColor: 'rgba(78, 245, 163, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                labels: { color: '#fff' }
              }
            },
            scales: {
              x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
              y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
          }
          }
        });
      } else if (earningsChart && data) {
        const earnings = [];
        for (let i = 6; i >= 0; i--) {
          earnings.push(data.dailyEarnings || 0);
        }
        earningsChart.data.datasets[0].data = earnings;
        earningsChart.update();
      }

      // Portfolio Composition Chart (Doughnut)
      const ctx2 = document.getElementById('portfolioChart');
      if (ctx2 && !portfolioChart) {
        const planCounts = {};
        (data.investments || []).forEach(inv => {
          planCounts[inv.plan] = (planCounts[inv.plan] || 0) + Number(inv.amount || 0);
        });
        
        if (Object.keys(planCounts).length === 0) {
          planCounts['No Investments'] = 1;
        }
        
        portfolioChart = new Chart(ctx2, {
          type: 'doughnut',
          data: {
            labels: Object.keys(planCounts),
            datasets: [{
              data: Object.values(planCounts),
              backgroundColor: [
                'rgba(78, 245, 163, 0.8)',
                'rgba(34, 197, 94, 0.8)',
                'rgba(22, 91, 71, 0.8)',
                'rgba(10, 61, 46, 0.8)',
                'rgba(15, 46, 35, 0.8)',
                'rgba(31, 184, 116, 0.8)'
              ]
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                labels: { color: '#fff' },
                position: 'bottom'
              }
            }
          }
        });
      } else if (portfolioChart && data) {
        const planCounts = {};
        (data.investments || []).forEach(inv => {
          planCounts[inv.plan] = (planCounts[inv.plan] || 0) + Number(inv.amount || 0);
        });
        
        if (Object.keys(planCounts).length === 0) {
          planCounts['No Investments'] = 1;
        }
        
        portfolioChart.data.labels = Object.keys(planCounts);
        portfolioChart.data.datasets[0].data = Object.values(planCounts);
        portfolioChart.update();
      }
    }

    async function refreshDashboard() {
      const user = getCurrentUser();
      if (!user) return;

      const email = user.email || user.userEmail;
      console.log('[Dashboard] User email:', email);
      
      if (!email) {
        console.error('[Dashboard] No email found in user object:', user);
        showError('User email not found. Please login again.');
        return;
      }
      
      try {
        // Update profits first
        try {
          await fetch('/profits/update', { method: 'POST', cache: 'no-store' });
        } catch (e) {
          console.warn('Profit update failed:', e);
        }
        
        // Fetch user data
        const data = await fetchUserData(email);
        
        // Update metrics
        const totalBalance = Number(data.totalBalance || 0);
        const totalInvestment = Number(data.totalInvestment || 0);
        const dailyEarnings = Number(data.dailyEarnings || 0);
        const bonus = Number(data.bonus || 0);
        const totalDeposits = Number(data.totalDeposits || 0);
        const totalProfit = Number(data.totalProfit || 0);

        if (document.getElementById('dashTotalBalance')) animateCounter(document.getElementById('dashTotalBalance'), 0, totalBalance, 1000);
        if (document.getElementById('dashTotalInvestment')) animateCounter(document.getElementById('dashTotalInvestment'), 0, totalInvestment, 1000);
        if (document.getElementById('dashDailyEarnings')) animateCounter(document.getElementById('dashDailyEarnings'), 0, dailyEarnings, 1000);
        if (document.getElementById('dashBonus')) animateCounter(document.getElementById('dashBonus'), 0, bonus, 1000);
        if (document.getElementById('dashTotalDeposits')) animateCounter(document.getElementById('dashTotalDeposits'), 0, totalDeposits, 1000);
        if (document.getElementById('dashTotalProfit')) animateCounter(document.getElementById('dashTotalProfit'), 0, totalProfit, 1000);

        // Update user info
        const displayName = data.name || email.split('@')[0] || 'Investor';
        if (document.getElementById('dashUserName')) {
          document.getElementById('dashUserName').textContent = displayName;
        }
        if (document.getElementById('dashUserEmail')) {
          document.getElementById('dashUserEmail').textContent = email;
        }
        if (data.profileImage && document.getElementById('dashAvatar')) {
          document.getElementById('dashAvatar').src = data.profileImage;
        }

        // Update investments table
        const body = document.getElementById('investmentsBody');
        if (body) {
          const investments = data.investments || [];
          if (investments.length === 0) {
            body.innerHTML = `
              <tr>
                <td colspan="6">
                  <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>No investments yet. Start investing to see your portfolio here.</p>
                  </div>
                </td>
              </tr>
            `;
          } else {
            body.innerHTML = investments.map(inv => {
              const rate = profitRates[inv.plan] || 0;
              const start = new Date(inv.startDate);
              const status = Math.floor((Date.now() - inv.startDate) / (1000*60*60*24)) < (inv.days||7) ? 'Active' : 'Completed';
              return `<tr>
                <td>${sanitizeHTML(inv.plan)}</td>
                <td>$${Number(inv.amount).toLocaleString()}</td>
                <td>${(rate*100).toFixed(1)}% Daily</td>
                <td><span style="color: ${status === 'Active' ? '#4ef5a3' : '#888'}">${status}</span></td>
                <td>${start.toISOString().split('T')[0]}</td>
                <td>$${(Number(inv.profit||0)).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}</td>
              </tr>`;
            }).join('');
          }
        }

        // Update charts
        updateCharts(data);
      } catch (error) {
        console.error('Dashboard refresh failed:', error);
        showError('Could not load dashboard data. Please try refreshing the page.');
      }
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
      console.log('[Dashboard] Page loaded, initializing...');
      const user = getCurrentUser();
      if (!user) {
        console.error('[Dashboard] No user found, redirecting...');
        return;
      }

      console.log('[Dashboard] User found:', user);
      showLoading(true);
      
      // Small delay to ensure DOM is ready
      setTimeout(() => {
        refreshDashboard();
      }, 100);
      
      // Refresh every 30 seconds
      setInterval(refreshDashboard, 30000);
    });
  </script>
</body>
</html>

