<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Email Notifications - Admin - RealSphere</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <!-- Loading Overlay - Hidden by default -->
  <div class="loading-overlay hidden" id="loadingOverlay" style="display: none !important;">
    <div class="spinner"></div>
  </div>
  
  <!-- Dashboard Logo (Top Left) -->
  <div class="dashboard-logo">
    <a href="../../index.html" style="display: inline-block; cursor: pointer;">
      <img src="../../Rswhite.png" alt="RealSphere">
    </a>
  </div>
  
  <!-- Mobile Hamburger Menu -->
  <div class="mobile-menu-toggle" id="mobileMenuToggle">
    <i class="fas fa-bars"></i>
  </div>
  
  <!-- Sidebar Container -->
  <div id="sidebar-container"></div>

  <!-- Main Content -->
  <div class="main-content">
    <header>
      <div class="user-info">
        <h1>Email Notifications <i class="fas fa-envelope"></i></h1>
        <div class="user-details">
          <span class="user-role">Administrator</span>
        </div>
      </div>
      <div class="header-spacer"></div>
      <button class="btn btn-primary" onclick="refreshEmailData()">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </header>

    <div class="dashboard-content">
      <!-- Notification Toggles Section -->
      <div class="admin-section">
        <h2><i class="fas fa-toggle-on"></i> Notification Settings</h2>
        <div class="glass-card">
          <div class="toggle-group">
            <label class="toggle-item">
              <input type="checkbox" id="toggleDeposits" checked>
              <span>Deposit Notifications</span>
            </label>
            <label class="toggle-item">
              <input type="checkbox" id="toggleWithdrawals" checked>
              <span>Withdrawal Notifications</span>
            </label>
            <label class="toggle-item">
              <input type="checkbox" id="toggleInvestments" checked>
              <span>Investment Notifications</span>
            </label>
            <label class="toggle-item">
              <input type="checkbox" id="toggleSystemAlerts" checked>
              <span>System Alerts</span>
            </label>
          </div>
          <button class="btn btn-primary" onclick="saveNotificationSettings()" style="margin-top: 1rem;">
            <i class="fas fa-save"></i> Save Settings
          </button>
        </div>
      </div>

      <!-- Broadcast Message Section -->
      <div class="admin-section">
        <h2><i class="fas fa-bullhorn"></i> Broadcast Message</h2>
        <div class="glass-card">
          <form id="broadcastForm">
            <div class="form-group">
              <label for="broadcastSubject">Subject</label>
              <input type="text" id="broadcastSubject" required placeholder="Enter email subject">
            </div>
            <div class="form-group">
              <label for="broadcastMessage">Message</label>
              <textarea id="broadcastMessage" rows="6" required placeholder="Enter message to send to all users"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-paper-plane"></i> Send to All Users
            </button>
          </form>
        </div>
      </div>

      <!-- Email Template Preview Section -->
      <div class="admin-section">
        <h2><i class="fas fa-eye"></i> Email Template Previews</h2>
        <div class="glass-card">
          <div class="template-preview-grid">
            <div class="template-preview-item">
              <h3>Verification Email</h3>
              <p>Sent when users register</p>
              <button class="btn btn-outline" onclick="previewTemplate('verifyEmail')">
                <i class="fas fa-eye"></i> Preview
              </button>
            </div>
            <div class="template-preview-item">
              <h3>Password Reset</h3>
              <p>Sent for password reset requests</p>
              <button class="btn btn-outline" onclick="previewTemplate('passwordReset')">
                <i class="fas fa-eye"></i> Preview
              </button>
            </div>
            <div class="template-preview-item">
              <h3>Deposit Notification</h3>
              <p>Sent for deposit updates</p>
              <button class="btn btn-outline" onclick="previewTemplate('depositNotification')">
                <i class="fas fa-eye"></i> Preview
              </button>
            </div>
            <div class="template-preview-item">
              <h3>Withdrawal Notification</h3>
              <p>Sent for withdrawal updates</p>
              <button class="btn btn-outline" onclick="previewTemplate('withdrawalNotification')">
                <i class="fas fa-eye"></i> Preview
              </button>
            </div>
            <div class="template-preview-item">
              <h3>Investment Created</h3>
              <p>Sent when investment is created</p>
              <button class="btn btn-outline" onclick="previewTemplate('investmentCreated')">
                <i class="fas fa-eye"></i> Preview
              </button>
            </div>
            <div class="template-preview-item">
              <h3>Investment Matured</h3>
              <p>Sent when investment completes</p>
              <button class="btn btn-outline" onclick="previewTemplate('investmentMatured')">
                <i class="fas fa-eye"></i> Preview
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Template Preview Modal -->
  <div class="modal" id="templatePreviewModal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2>Email Template Preview</h2>
        <button class="modal-close" onclick="closeModal('templatePreviewModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <iframe id="templatePreview" style="width: 100%; height: 600px; border: none; border-radius: 8px;"></iframe>
      </div>
    </div>
  </div>

  <script src="../script.js"></script>
  <script src="../admin.js"></script>
  <script>
    // Check admin auth
    if (localStorage.getItem('isAdmin') !== 'true') {
      window.location.href = '../admin-login.html';
    }

    // Hide loading overlay immediately - multiple methods to ensure it works
    function hideLoadingOverlay() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.classList.add('hidden');
        overlay.style.display = 'none';
        overlay.style.visibility = 'hidden';
        overlay.style.opacity = '0';
      }
      // Also use showLoading function if available
      if (typeof showLoading === 'function') {
        showLoading(false);
      }
    }

    // Hide overlay immediately - no delay
    hideLoadingOverlay();

    // Also hide on DOMContentLoaded as backup
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', hideLoadingOverlay);
    } else {
      // Page already loaded, hide immediately
      hideLoadingOverlay();
    }

    // Also hide on window load as backup
    window.addEventListener('load', hideLoadingOverlay);

    // Final safety: hide after 1 second maximum
    setTimeout(hideLoadingOverlay, 1000);

    // Initialize sidebar using admin.js function
    function initAdminDashboard() {
      const sidebarContainer = document.getElementById('sidebar-container');
      if (sidebarContainer && typeof renderAdminSidebar === 'function') {
        sidebarContainer.innerHTML = renderAdminSidebar('emails.html');
      }
      
      // Setup mobile menu toggle
      const mobileMenuToggle = document.getElementById('mobileMenuToggle');
      if (mobileMenuToggle) {
        mobileMenuToggle.addEventListener('click', () => {
          const sidebar = document.querySelector('.sidebar');
          if (sidebar) {
            sidebar.classList.toggle('active');
          }
        });
      }
    }
    
    // Initialize on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        initAdminDashboard();
        loadNotificationSettings();
      });
    } else {
      initAdminDashboard();
      loadNotificationSettings();
    }

    function refreshEmailData() {
      loadNotificationSettings();
      showToast('Email data refreshed', 'success');
    }

    function loadNotificationSettings() {
      // Load from localStorage (in production, fetch from API)
      const settings = JSON.parse(localStorage.getItem('emailSettings') || '{"deposits":true,"withdrawals":true,"investments":true,"systemAlerts":true}');
      document.getElementById('toggleDeposits').checked = settings.deposits;
      document.getElementById('toggleWithdrawals').checked = settings.withdrawals;
      document.getElementById('toggleInvestments').checked = settings.investments;
      document.getElementById('toggleSystemAlerts').checked = settings.systemAlerts;
    }

    function saveNotificationSettings() {
      const settings = {
        deposits: document.getElementById('toggleDeposits').checked,
        withdrawals: document.getElementById('toggleWithdrawals').checked,
        investments: document.getElementById('toggleInvestments').checked,
        systemAlerts: document.getElementById('toggleSystemAlerts').checked
      };
      localStorage.setItem('emailSettings', JSON.stringify(settings));
      showToast('Notification settings saved', 'success');
    }

    document.getElementById('broadcastForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const subject = document.getElementById('broadcastSubject').value;
      const message = document.getElementById('broadcastMessage').value;

      try {
        const response = await adminFetch('/api/admin/broadcast-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subject, message })
        });

        const data = await response.json();
        if (response.ok) {
          showToast('Broadcast message sent successfully', 'success');
          document.getElementById('broadcastForm').reset();
        } else {
          showToast(data.message || 'Failed to send broadcast', 'error');
        }
      } catch (error) {
        showToast('Error sending broadcast message', 'error');
      }
    });

    function previewTemplate(templateName) {
      // For now, show a placeholder. In production, fetch actual template from API
      const previews = {
        verifyEmail: '<html><body><h2>Verification Email Template</h2><p>This is a preview of the verification email sent to new users.</p></body></html>',
        passwordReset: '<html><body><h2>Password Reset Template</h2><p>This is a preview of the password reset email.</p></body></html>',
        depositNotification: '<html><body><h2>Deposit Notification Template</h2><p>This is a preview of the deposit notification email.</p></body></html>',
        withdrawalNotification: '<html><body><h2>Withdrawal Notification Template</h2><p>This is a preview of the withdrawal notification email.</p></body></html>',
        investmentCreated: '<html><body><h2>Investment Created Template</h2><p>This is a preview of the investment creation email.</p></body></html>',
        investmentMatured: '<html><body><h2>Investment Matured Template</h2><p>This is a preview of the investment matured email.</p></body></html>'
      };
      
      const iframe = document.getElementById('templatePreview');
      iframe.srcdoc = previews[templateName] || '<p>Template preview not available</p>';
      openModal('templatePreviewModal');
    }

    // Add styles for email page
    const style = document.createElement('style');
    style.textContent = `
      .toggle-group {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .toggle-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        color: #fff;
        cursor: pointer;
      }
      .toggle-item input[type="checkbox"] {
        width: 24px;
        height: 24px;
        cursor: pointer;
      }
      .template-preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
      }
      .template-preview-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 1.5rem;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .template-preview-item h3 {
        color: #4ef5a3;
        margin-bottom: 0.5rem;
      }
      .template-preview-item p {
        color: #ccc;
        margin-bottom: 1rem;
        font-size: 0.9rem;
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>

